# Calculator API Spring

é€™æ˜¯ä¸€å€‹åŸºæ–¼ Spring Boot çš„è²¡å‹™è¨ˆç®—æ©Ÿ APIï¼Œä¸»è¦åŠŸèƒ½ç‚ºè¤‡åˆ©è¨ˆç®— (Compound Interest) èˆ‡å€‹äººç†è²¡æª”æ¡ˆç®¡ç†ã€‚
å°ˆæ¡ˆæ¡ç”¨ **MyBatis** ä½œç‚º ORM æ¡†æ¶ï¼Œé€£æ¥è‡³ **Neon (PostgreSQL)** é›²ç«¯è³‡æ–™åº«ï¼Œä¸¦æ•´åˆ **Firebase Admin SDK** é€²è¡Œèº«ä»½é©—è­‰èˆ‡å¾Œç«¯æ“´å……æœå‹™ã€‚

## ğŸ› ï¸ æŠ€è¡“æ£§ (Tech Stack)

* **Java**: 17
* **Framework**: Spring Boot 3.3.2
* **ORM**: MyBatis Spring Boot Starter 3.0.4
* **Database**: PostgreSQL (Neon Serverless)
* **Cloud Service**: Firebase Admin SDK (Java)
* **Documentation**: SpringDoc OpenAPI (Swagger UI)
* **Tooling**: Maven, Lombok

## ğŸ“¦ ä¾è³´å¥—ä»¶è©³è§£ (Dependencies Explained)

ç‚ºäº†è®“é–‹ç™¼è€…æ›´æ¸…æ¥š `pom.xml` ä¸­å„é …ä¾è³´çš„ç”¨é€”ï¼Œä»¥ä¸‹é€ä¸€è§£ææœ¬å°ˆæ¡ˆçš„æ ¸å¿ƒå¥—ä»¶ï¼š

| å¥—ä»¶åç¨± | ç”¨é€”èªªæ˜ |
| :--- | :--- |
| **Web åŸºç¤** | |
| `spring-boot-starter-web` | å»ºç«‹ RESTful API çš„æ ¸å¿ƒï¼Œå…§å« Tomcat ä¼ºæœå™¨èˆ‡ Spring MVCã€‚ |
| `spring-boot-starter-actuator` | æä¾›ç”Ÿç”¢ç’°å¢ƒçš„ç›£æ§ç«¯é» (å¦‚ `/actuator/health`)ï¼Œç”¨æ–¼æª¢æŸ¥ç³»çµ±ç‹€æ…‹ã€‚ |
| **è³‡æ–™åº«èˆ‡æŒä¹…å±¤** | |
| `mybatis-spring-boot-starter` | SQL æ˜ å°„æ¡†æ¶ï¼Œæ”¯æ´è‡ªå®šç¾© SQL æŸ¥è©¢ï¼Œé©åˆè™•ç†è¤‡é›œè²¡å‹™é‚è¼¯ã€‚ |
| `postgresql` | PostgreSQL è³‡æ–™åº«é©…å‹•ç¨‹å¼ (JDBC Driver)ã€‚ |
| **å®‰å…¨æ€§èˆ‡é©—è­‰** | |
| `spring-boot-starter-security` | è² è²¬ API çš„å®‰å…¨é˜²è­·ã€æ¬Šé™æ§ç®¡ (Authentication & Authorization)ã€‚ |
| `firebase-admin` | Google Firebase SDKï¼Œç”¨æ–¼é©—è­‰å‰ç«¯å‚³ä¾†çš„ Token æˆ–ç®¡ç†ä½¿ç”¨è€…ã€‚ |
| **é–‹ç™¼å·¥å…·** | |
| `lombok` | é€éè¨»è§£ (`@Data`, `@Builder`) è‡ªå‹•ç”¢ç”Ÿç¨‹å¼ç¢¼ï¼Œæ¸›å°‘ Boilerplate codeã€‚ |
| `springdoc-openapi-starter-webmvc-ui` | è‡ªå‹•æƒæ Controller ç”Ÿæˆ Swagger/OpenAPI æ–‡ä»¶ï¼Œæ–¹ä¾¿ API æ¸¬è©¦ã€‚ |
| `spring-boot-configuration-processor` | å”åŠ© IDE è®€å–è‡ªå®šç¾©é…ç½® (`@ConfigurationProperties`) ä¸¦æä¾›æç¤ºã€‚ |
| **æ¸¬è©¦** | |
| `spring-boot-starter-test` | åŒ…å« JUnit 5, Mockito ç­‰å–®å…ƒæ¸¬è©¦èˆ‡æ•´åˆæ¸¬è©¦å·¥å…·ã€‚ |
| `spring-security-test` | å°ˆé–€ç”¨æ–¼æ¸¬è©¦ Spring Security ç›¸é—œåŠŸèƒ½çš„å·¥å…·ã€‚ |

---

## âš™ï¸ æ‡‰ç”¨ç›£æ§ (Application Monitoring)

æœ¬å°ˆæ¡ˆæ•´åˆäº† **Spring Boot Actuator**ï¼Œæä¾›å¤šå€‹ç›£æ§ç«¯é» (Endpoint) ä¾†è§€å¯Ÿæ‡‰ç”¨ç¨‹å¼çš„å…§éƒ¨ç‹€æ…‹ã€‚

### å¦‚ä½•æŸ¥çœ‹ç›£æ§æŒ‡æ¨™

1.  **å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼**ã€‚
2.  **æ‰“é–‹ Swagger UI**: å‰å¾€ `http://localhost:8888/swagger-ui/index.html`ã€‚
3.  **é¸æ“‡ "actuator" ç¾¤çµ„**: åœ¨é é¢å³ä¸Šè§’çš„ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ `actuator`ã€‚
4.  **å±•é–‹ `metrics-endpoint`**: æ‰¾åˆ°ä¸¦å±•é–‹ `GET /actuator/metrics/{name}`ã€‚
5.  **è¼¸å…¥æŒ‡æ¨™åç¨±ä¸¦åŸ·è¡Œ**:
    *   é»æ“Š "Try it out"ã€‚
    *   åœ¨ `name` æ¬„ä½è¼¸å…¥ä½ æƒ³æŸ¥è©¢çš„æŒ‡æ¨™ï¼Œä¾‹å¦‚ `jvm.memory.used`ã€‚
    *   é»æ“Š "Execute"ã€‚

### å¸¸ç”¨è¨˜æ†¶é«”æŒ‡æ¨™

| æŒ‡æ¨™åç¨± | èªªæ˜ |
| :--- | :--- |
| **`jvm.memory.used`** | **å·²ä½¿ç”¨è¨˜æ†¶é«”**ï¼šæ‡‰ç”¨ç¨‹å¼ç•¶ä¸‹çœŸæ­£ä½”ç”¨çš„è¨˜æ†¶é«”é‡ã€‚ |
| **`jvm.memory.committed`** | **å·²æäº¤è¨˜æ†¶é«”**ï¼šJVM å·²å‘ä½œæ¥­ç³»çµ±ã€Œé ç•™ã€çš„ç¸½è¨˜æ†¶é«”ç©ºé–“ã€‚ |
| **`jvm.memory.max`** | **æœ€å¤§å¯ç”¨è¨˜æ†¶é«”**ï¼šJVM å¯ä½¿ç”¨çš„æœ€å¤§è¨˜æ†¶é«”ä¸Šé™ (å°æ‡‰ `-Xmx` è¨­å®š)ã€‚ |

---

## ğŸ—ï¸ å°ˆæ¡ˆæ¶æ§‹èˆ‡é–‹ç™¼è¦ç¯„ (Architecture & Guidelines)

æœ¬å°ˆæ¡ˆéµå¾ªé‡‘èç´šé–‹ç™¼è¦ç¯„ï¼Œé‡å°è³‡æ–™æ¨¡å‹èˆ‡è³‡æ–™åº«å­˜å–å±¤æ¡ç”¨ä»¥ä¸‹è¨­è¨ˆæ¨¡å¼ï¼š

### 1. è³‡æ–™æ¨¡å‹åˆ†å±¤ (Entity vs. Model/DTO)

ç‚ºäº†ç¢ºä¿å®‰å…¨æ€§èˆ‡è·è²¬åˆ†é›¢ï¼Œæˆ‘å€‘åš´æ ¼å€åˆ† **Entity** èˆ‡ **DTO**ï¼š

| å±¤ç´š | è³‡æ–™å¤¾è·¯å¾‘ (`package`) | çµå°¾å‘½å | è·è²¬ (Responsibility) | ç‰¹å¾µ |
| --- | --- | --- | --- | --- |
| **DTO (å‚³è¼¸å±¤)** | `src/main/java/.../model` | `*Req`, `*Res`, `*Dto` | **é¢å°å‰ç«¯/API**ã€‚è² è²¬è³‡æ–™å‚³è¼¸ã€è¼¸å…¥é©—è­‰ (`@NotBlank`)ã€æ ¼å¼åŒ–è¼¸å‡º (`@JsonProperty`)ã€‚ | ä¸å« DB å…§éƒ¨æ¬„ä½ã€ä½¿ç”¨ String æ¥æ—¥æœŸä»¥å®¹éŒ¯ã€‚ |
| **Entity (æŒä¹…å±¤)** | `src/main/java/.../entity` | `*` (ç„¡å¾Œç¶´) | **é¢å°è³‡æ–™åº«**ã€‚è² è²¬èˆ‡ Table çµæ§‹ 1:1 å°æ‡‰ã€‚ | åŒ…å«å¯©è¨ˆæ¬„ä½ (`updated_at`)ã€ç²¾ç¢ºå°æ‡‰ DB å‹åˆ¥ã€‚ |

### 2. MyBatis å¯¦ä½œæ¨¡å¼ (Interface vs. XML)

æœ¬å°ˆæ¡ˆæ¡ç”¨ **XML Configuration** æ¨¡å¼ï¼Œä»¥æ”¯æ´è¤‡é›œçš„ SQL é‚è¼¯ (å¦‚ Upsert)ï¼š

* **Java Interface (èœå–®)**:
* ä½ç½®: `src/main/java/.../mapper/*.java`
* ä½œç”¨: å®šç¾© Java æ–¹æ³•ç°½ç«  (Method Signature)ã€‚
* **æ³¨æ„**: ä»‹é¢ä¸Šéœ€æ¨™è¨» `@Mapper`ã€‚


* **XML Mapper (é£Ÿè­œ)**:
* ä½ç½®: `src/main/resources/mapper/*.xml`
* ä½œç”¨: æ’°å¯«å¯¦éš›çš„ SQL èªå¥ã€‚
* **é—œéµ**: XML çš„ `namespace` å±¬æ€§å¿…é ˆå®Œå…¨åŒ¹é… Java Interface çš„å®Œæ•´è·¯å¾‘ã€‚



---

## ğŸš€ å¿«é€Ÿé–‹å§‹ (Getting Started)

### 1. è³‡æ–™åº«åˆå§‹åŒ– (Database Setup)

è«‹åœ¨ä½ çš„ PostgreSQL è³‡æ–™åº«ä¸­åŸ·è¡Œä»¥ä¸‹ SQL ä»¥å»ºç«‹æ‰€éœ€è¡¨æ ¼ï¼š

```sql
-- 1. è¤‡åˆ©è¨ˆç®—ç´€éŒ„è¡¨
CREATE TABLE IF NOT EXISTS calculation_records (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    principal DECIMAL(19, 2), -- æœ¬é‡‘
    rate DECIMAL(5, 4),       -- åˆ©ç‡
    years INT,                -- å¹´åˆ†
    result DECIMAL(19, 2),    -- è¨ˆç®—çµæœ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. ç”¨æˆ¶å€‹äººæª”æ¡ˆè¡¨ (ä½¿ç”¨ Firebase UID ä½œç‚º PK)
CREATE TABLE IF NOT EXISTS user_profiles (
    firebase_uid VARCHAR(128) PRIMARY KEY,   -- å°æ‡‰ Firebase uid
    birth_year INT,
    birth_date DATE,
    gender VARCHAR(10),
    current_age INT,
    life_expectancy INT,
    marriage_year INT,
    career_insurance_type VARCHAR(50),
    biography TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

```

### 2. ç’°å¢ƒè®Šæ•¸èˆ‡å¤–éƒ¨é‡‘é‘°è¨­å®š (Configuration & Secrets)

ç‚ºäº†ç¢ºä¿è³‡å®‰ï¼Œæœ¬å°ˆæ¡ˆ **ä¸å°‡æ•æ„Ÿè³‡è¨Šæ˜æ–‡å¯«å…¥** ç¨‹å¼ç¢¼æˆ–è¨­å®šæª”ã€‚è«‹å‹™å¿…å®Œæˆä»¥ä¸‹å…©é …è¨­å®šï¼š

#### **A. è¨­å®šç’°å¢ƒè®Šæ•¸ (Database)**

è«‹åœ¨ IDE (å¦‚ Eclipse/IntelliJ) çš„ `Run Configurations` -> `Environment` ä¸­è¨­å®šä»¥ä¸‹è®Šæ•¸ï¼š

| è®Šæ•¸åç¨± (Variable) | èªªæ˜ (Description) | ç¯„ä¾‹å€¼ (Example) |
| --- | --- | --- |
| **DB_URL** | JDBC é€£ç·šå­—ä¸² | `jdbc:postgresql://<HOST>/neondb?sslmode=require` |
| **DB_USERNAME** | è³‡æ–™åº«å¸³è™Ÿ | `neondb_owner` |
| **DB_PASSWORD** | è³‡æ–™åº«å¯†ç¢¼ | `********` |

#### **B. Firebase é‡‘é‘°æº–å‚™ (Firebase Admin SDK)**

æœ¬å°ˆæ¡ˆéœ€æ‰‹å‹•é…ç½® Firebase æ†‘è­‰ï¼Œè«‹ä¾åºåŸ·è¡Œï¼š

1. å‰å¾€ [Firebase Console](https://console.firebase.google.com/)ã€‚
2. é€²å…¥ **å°ˆæ¡ˆè¨­å®š > æœå‹™å¸³æˆ¶ (Service Accounts)**ã€‚
3. é»æ“Š **ã€Œç”¢ç”Ÿæ–°çš„ç§å¯†é‡‘é‘°ã€** ä¸¦ä¸‹è¼‰ JSON æª”æ¡ˆã€‚
4. å°‡è©²æª”æ¡ˆé‡æ–°å‘½åç‚º **`serviceAccountKey.json`**ã€‚
5. å°‡æª”æ¡ˆæ”¾å…¥å°ˆæ¡ˆè·¯å¾‘ï¼š`src/main/resources/serviceAccountKey.json`ã€‚

> âš ï¸ **è³‡å®‰è­¦ç¤º**ï¼š`serviceAccountKey.json` åŒ…å«å°ˆæ¡ˆæœ€é«˜æ¬Šé™ï¼Œæœ¬å°ˆæ¡ˆå·²å°‡å…¶åŠ å…¥ `.gitignore`ã€‚è«‹å‹¿å°‡æ­¤é‡‘é‘°ä¸Šå‚³è‡³ GitHub ç­‰å…¬å…±å„²å­˜åº«ã€‚

### 3. è¨­å®šæª”çµæ§‹ (application.yaml)

```yaml
spring:
  datasource:
    url: ${DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver

mybatis:
  # å‘Šè¨´ MyBatis XML æª”æ¡ˆæ”¾åœ¨å“ªè£¡
  mapper-locations: classpath:mapper/*.xml
  # è¨­å®š Model çš„åˆ¥ååŒ… (é¸ç”¨)
  type-aliases-package: com.en_chu.calculator_api_spring.model
  configuration:
    # é–‹ç™¼æ™‚å»ºè­°é–‹å•Ÿï¼ŒæŸ¥çœ‹ SQL Log
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

```

---

## ğŸ“– API æ–‡ä»¶ (Swagger)

å°ˆæ¡ˆå•Ÿå‹•å¾Œï¼Œå¯é€é Swagger UI é€²è¡Œè¦–è¦ºåŒ–æ¸¬è©¦ï¼š

* **URL**: `http://localhost:8888/swagger-ui/index.html`

---

## ğŸ”§ å¸¸è¦‹å•é¡Œèˆ‡æŒ‡ä»¤ (Troubleshooting)

### 1. é€£æ¥åŸ è¢«ä½”ç”¨ (Port 8888 already in use)

è‹¥é‡æ–°å•Ÿå‹•æ™‚ç™¼ç¾ Port 8888 è¢«ä½”ç”¨ï¼Œè«‹åœ¨ Windows æŒ‡ä»¤è¡ŒåŸ·è¡Œï¼š

```cmd
netstat -ano | findstr :8888
taskkill /F /PID <æŸ¥è©¢åˆ°çš„PID>

```

### 2. Firebase åˆå§‹åŒ–å¤±æ•—

è‹¥å•Ÿå‹•æ™‚å™´å‡º `FileNotFoundException`ï¼Œè«‹ç¢ºèª `serviceAccountKey.json` æ˜¯å¦å·²æ­£ç¢ºæ”¾ç½®æ–¼ `src/main/resources/` ç›®éŒ„ä¸‹ã€‚

### 3. Invalid bound statement (not found)

è‹¥å‘¼å« Mapper æ™‚å™´å‡ºæ­¤éŒ¯èª¤ï¼Œä»£è¡¨ MyBatis æ‰¾ä¸åˆ°å°æ‡‰çš„ XMLã€‚è«‹æª¢æŸ¥ï¼š

1. `mapper-locations` è¨­å®šæ˜¯å¦æ­£ç¢ºæŒ‡å‘ `classpath:mapper/*.xml`ã€‚
2. XML ä¸­çš„ `namespace` æ˜¯å¦èˆ‡ Mapper Interface çš„ package è·¯å¾‘ **å®Œå…¨ä¸€è‡´**ã€‚
3. XML ä¸­çš„ `id` æ˜¯å¦èˆ‡ Interface çš„ **æ–¹æ³•åç¨±ä¸€è‡´**ã€‚