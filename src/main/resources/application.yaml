server:
  # 雲端環境通常會注入 PORT 環境變數，若無則預設 8080
  port: ${PORT:8080}

spring:
  application:
    name: calculator-api-spring
  # ⚠️ 注意：這裡移除了 profiles.active: dev
  # 這樣預設啟動就會是 Production 模式
  
  datasource:
    # 資料庫連線維持使用環境變數，確保帳密不寫死在檔案中
    url: jdbc:postgresql://${DB_HOST:ep-holy-mud-a1v9v56m-pooler.ap-southeast-1.aws.neon.tech}:${DB_PORT:5432}/${DB_NAME:neondb}?sslmode=require
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    # HikariCP 連線池設定
    hikari:
      # 應用程式啟動時，如果無法從連線池中至少取得一個連線，就快速失敗
      initialization-fail-timeout: 0
      # 連線測試查詢，在將連線交給應用程式前，確保其有效
      connection-test-query: "SELECT 1"
      # 從池中獲取連線的最大等待時間 (30秒)
      connection-timeout: 30000
      # 最小閒置連線數 (Cloud Run 縮容到 0 時，這個設定會失效，但在運行時有用)
      minimum-idle: 5
      # --- 核心保活設定 ---
      # 一個連線的最大存活時間 (設定為 29 分鐘，比常見的 30 分鐘防火牆超時更短)
      max-lifetime: 1740000 
      # 保活心跳時間 (設定為 4 分鐘，確保比 Neon DB 的 5 分鐘休眠更短)
      # HikariCP 會在一個連線閒置超過此時間後，發送一次 connection-test-query 來「喚醒」它
      keepalive-time: 240000

mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.en_chu.calculator_api_spring.model

# ✅ 正式環境：嚴格的 CORS 白名單
app:
  cors:
    allowed-origins:
      - https://enchu-8085a.web.app
      - https://enchu-8085a.firebaseapp.com
      - https://www.en-chu.com
      - https://planner-api-spring-592400229145.asia-east1.run.app

# 監控端點設定
management:
  endpoints:
    web:
      exposure:
        # 開放 health, info, 和 metrics
        include: health,info,metrics
  endpoint:
    health:
      # 顯示詳細健康資訊 (例如：資料庫連線狀態)
      show-details: always
      # 將資料庫的健康狀況也納入整體健康狀態
      probes:
        enabled: true

# SpringDoc (Swagger) 設定
springdoc:
  # 讓 springdoc 自動建立並管理 actuator 群組
  show-actuator: true
