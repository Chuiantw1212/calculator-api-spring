<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.en_chu.calculator_api_spring.mapper.UserProfileMapper">

	<insert id="upsertProfile" useGeneratedKeys="true" keyProperty="id">
        <![CDATA[
            INSERT INTO usr_profiles (
                user_id, 
                birth_date, 
                gender,
                current_age, 
                life_expectancy, 
                marriage_year,
                career_insurance_type, 
                biography
            ) VALUES (
                #{uid},  -- 這裡是 Auth UID 字串
                #{birthDate}, 
                #{gender},
                #{currentAge}, 
                #{lifeExpectancy}, 
                #{marriageYear},
                #{careerInsuranceType}, 
                #{biography}
            )
            ON CONFLICT (user_id) -- 假設 user_id 欄位有設 Unique Constraint
            DO UPDATE SET
                birth_date = EXCLUDED.birth_date,
                gender = EXCLUDED.gender,
                current_age = EXCLUDED.current_age,
                life_expectancy = EXCLUDED.life_expectancy,
                marriage_year = EXCLUDED.marriage_year,
                career_insurance_type = EXCLUDED.career_insurance_type,
                biography = EXCLUDED.biography,
                updated_at = CURRENT_TIMESTAMP
        ]]>
    </insert>

	<select id="selectByUid"
		resultType="com.en_chu.calculator_api_spring.entity.UserProfile">
        <![CDATA[
            SELECT 
                id,            -- DB 的 Primary Key
                user_id AS uid, -- DB 的 Auth ID 對應 Java 的 uid
                birth_date AS birthDate,
                gender,
                current_age AS currentAge,
                life_expectancy AS lifeExpectancy,
                marriage_year AS marriageYear,
                career_insurance_type AS careerInsuranceType,
                biography,
                created_at AS createdAt,
                updated_at AS updatedAt
            FROM usr_profiles
            WHERE user_id = #{uid}
        ]]>
    </select>

	<select id="selectById"
		resultType="com.en_chu.calculator_api_spring.entity.UserProfile">
        <![CDATA[
            SELECT 
                id,
                user_id AS uid,
                birth_year AS birthYear,
                birth_date AS birthDate,
                gender,
                current_age AS currentAge,
                life_expectancy AS lifeExpectancy,
                marriage_year AS marriageYear,
                career_insurance_type AS careerInsuranceType,
                biography,
                created_at AS createdAt,
                updated_at AS updatedAt
            FROM usr_profiles
            WHERE id = #{id}
        ]]>
    </select>

</mapper>