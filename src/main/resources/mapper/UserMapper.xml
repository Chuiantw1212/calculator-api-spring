<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.en_chu.calculator_api_spring.mapper.UserMapper">

	<resultMap id="UserFullDataResultMap"
		type="com.en_chu.calculator_api_spring.model.UserFullDataRes">

		<id property="id" column="p_id" />

		<association property="profile"
			javaType="com.en_chu.calculator_api_spring.model.UserProfileDto">
			<id property="id" column="p_id" />

			<result property="birthDate" column="p_birth_date" />
			<result property="gender" column="p_gender" />
			<result property="currentAge" column="p_current_age" />
			<result property="lifeExpectancy" column="p_life_expectancy" />
			<result property="marriageYear" column="p_marriage_year" />
			<result property="careerInsuranceType"
				column="p_career_insurance_type" />
			<result property="biography" column="p_biography" />
		</association>

		<association property="career"
			javaType="com.en_chu.calculator_api_spring.model.UserCareerDto">
			<id property="id" column="c_id" />
			<result property="baseSalary" column="c_base_salary" />
			<result property="otherAllowance" column="c_other_allowance" />
			<result property="laborInsurance" column="c_labor_insurance" />
			<result property="healthInsurance" column="c_health_insurance" />
			<result property="otherDeduction" column="c_other_deduction" />
			<result property="pensionRate" column="c_pension_rate" />
			<result property="pensionAmount" column="c_pension_amount" />
			<result property="stockDeduction" column="c_stock_deduction" />
			<result property="stockCompanyMatch"
				column="c_stock_company_match" />
		</association>
	</resultMap>

	<select id="selectFullUserDataByFirebaseUid"
		resultMap="UserFullDataResultMap">
    <![CDATA[
        SELECT
            -- UserProfile 欄位 (核心表)
            p.id                    AS p_id,
            p.birth_date            AS p_birth_date,
            p.gender                AS p_gender,
            p.current_age           AS p_current_age,
            p.life_expectancy       AS p_life_expectancy,
            p.marriage_year         AS p_marriage_year,
            p.career_insurance_type AS p_career_insurance_type,
            p.biography             AS p_biography,

            -- UserCareer 欄位 (附屬表)
            c.id                    AS c_id,
            c.base_salary           AS c_base_salary,
            c.other_allowance       AS c_other_allowance,
            c.labor_insurance       AS c_labor_insurance,
            c.health_insurance      AS c_health_insurance,
            c.other_deduction       AS c_other_deduction,
            c.pension_rate          AS c_pension_rate,
            c.pension_amount        AS c_pension_amount,
            c.stock_deduction       AS c_stock_deduction,
            c.stock_company_match   AS c_stock_company_match

        FROM user_profiles p
        -- 使用 LEFT JOIN 連結 Career (透過 firebase_uid)
        LEFT JOIN user_careers c ON p.firebase_uid = c.firebase_uid
        WHERE p.firebase_uid = #{firebaseUid}
    ]]>
	</select>

	<select id="checkUserExists" resultType="boolean">
    <![CDATA[
        SELECT COUNT(1) > 0
        FROM user_profiles
        WHERE firebase_uid = #{firebaseUid}
    ]]>
	</select>

	<insert id="insertUser" useGeneratedKeys="true" keyProperty="id">
    <![CDATA[
        INSERT INTO user_profiles (firebase_uid, created_at, updated_at)
        VALUES (#{firebaseUid}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    ]]>
	</insert>

	<update id="updateLastLogin">
    <![CDATA[
        UPDATE user_profiles
        SET updated_at = CURRENT_TIMESTAMP
        WHERE firebase_uid = #{firebaseUid}
    ]]>
	</update>

</mapper>